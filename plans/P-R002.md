# P-R002: Implementation Plan for R002

## Requirement Reference
[R002: Multi-Resolution Support and Enhanced Visual Feedback](../requirements/R002.md)

## Objective
Add multi-resolution support with dynamic UI scaling, centralized tile layout, 3D flip animations, and visual feedback for non-matching tiles.

## Proposed Approach

### Resolution Management
- Extend GameSettings singleton to store resolution preference
- Add resolution presets for Desktop, High-DPI Desktop, and iPad Mini
- Use Godot's get_window().size to apply resolution changes
- Implement viewport scaling strategy for consistent UI across resolutions

### Dynamic Tile Sizing and Centering
- Calculate tile size based on viewport dimensions and tile count
- Use Container nodes (CenterContainer or VBoxContainer) for centering
- Add margin/padding calculations to keep tiles properly spaced
- Ensure grid stays centered regardless of screen size

### 3D Flip Animation
- Modify Tile.tscn to use Node3D or simulate 3D using rotation_degrees.y
- Alternative: Use scale.x manipulation to simulate perspective flip
- Update animation tracks to rotate around Y-axis (0° → 90° → 180°)
- Switch texture at 90° midpoint for smooth front/back transition

### Negative Feedback System
- Add Panel or ColorRect outline to Tile scene
- Create "blink_red" animation: 2 cycles in 500ms (visible 125ms, hidden 125ms)
- Trigger before the 5-second auto-flip timer
- Use modulate property for red coloring

## Implementation Steps

### 1. Update GameSettings for Resolution
1. Add resolution constants and current_resolution variable to GameSettings.gd
2. Add resolution presets:
   - Desktop: 1280x720 or 1920x1080
   - High-DPI: 2560x1440 or 3840x2160
   - iPad Mini: 2048x1536 or 1024x768
3. Add save/load methods for resolution setting
4. Add apply_resolution() method to change window size

### 2. Update Settings Scene UI
1. Add resolution OptionButton to SettingsScene.tscn
2. Populate with resolution options
3. Connect to GameSettings.set_resolution()
4. Display current resolution on scene load
5. Optional: Add "Apply" and "Restart Required" messaging

### 3. Implement Dynamic Tile Sizing
1. Update GameBoard.gd to calculate tile size dynamically:
   - Get viewport size
   - Calculate available space (viewport - margins)
   - Determine optimal tile size based on grid columns/rows
   - Set custom_minimum_size on tiles
2. Add padding/margin calculations for spacing
3. Test with all tile counts (8, 12, 16, 24)

### 4. Center Tile Grid
1. Wrap GridContainer in CenterContainer in GameScene.tscn
2. Add vertical and horizontal centering
3. Ensure back button and victory panel remain properly positioned
4. Test at all supported resolutions

### 5. Implement 3D Flip Animation
1. Update Tile.tscn animation approach:
   - **Option A** (True 3D): Add SubViewport with Node3D for real 3D rotation
   - **Option B** (Simulated): Use rotation_degrees.y with perspective shader
   - **Option C** (Simple): Scale.x flip from 1 → 0 → 1 with texture swap
2. Recommended: Option C for mobile performance
3. Update flip_to_front and flip_to_back animations:
   ```
   0.0s: scale.x = 1.0, texture = back
   0.15s: scale.x = 0.0 (texture swap here)
   0.3s: scale.x = 1.0, texture = front
   ```
4. Add slight Y offset for depth perception (optional)

### 6. Add Red Outline Blink Effect
1. Add Panel or NinePatchRect outline to Tile.tscn:
   - Position behind TextureRect
   - 4px border, transparent center
   - Red color (Color(1, 0, 0, 1))
   - Initially hidden
2. Create "blink_error" animation in Tile:
   - Track: outline visibility
   - Duration: 0.5s
   - Keyframes: show (0s), hide (0.125s), show (0.25s), hide (0.375s)
3. Update Tile.gd to add play_error_animation() method
4. Call from GameBoard.gd before flip_back timer

### 7. Update Game Flow for Negative Feedback
1. Modify check_match() in GameBoard.gd:
   ```gdscript
   if not match:
       first_tile.play_error_animation()
       second_tile.play_error_animation()
       await get_tree().create_timer(0.5).timeout  # Wait for blink
       await get_tree().create_timer(4.5).timeout  # Remaining time to 5s
       first_tile.flip_back()
       second_tile.flip_back()
   ```

### 8. Test Across Resolutions
1. Test each resolution preset
2. Verify tile scaling at all tile counts
3. Confirm centering on all resolutions
4. Test 3D flip animation smoothness
5. Verify red blink timing and appearance
6. Check performance on lower-end devices

## Files to be Modified/Created

### Modified Files
- `scripts/GameSettings.gd` - Add resolution management
- `scripts/GameBoard.gd` - Dynamic tile sizing, negative feedback trigger
- `scripts/Tile.gd` - Add play_error_animation() method
- `scenes/SettingsScene.tscn` - Add resolution selector UI
- `scenes/SettingsScene.gd` - Handle resolution changes
- `scenes/GameScene.tscn` - Add CenterContainer for grid
- `scenes/Tile.tscn` - Add outline, update flip animation, add blink animation
- `project.godot` - May need to adjust default window size

### No New Files Required
All changes are modifications to existing files.

## Technical Considerations

### Performance
- 3D rotation can be expensive on mobile - use simulated flip if needed
- Test particle effects don't impact frame rate
- Ensure blink animation doesn't cause stuttering
- Consider texture compression for high-DPI assets

### Resolution Scaling
- Use aspect ratio independent scaling where possible
- Test on actual devices, not just window resizing
- Consider safe areas for notched displays
- Ensure touch targets remain adequate at all resolutions

### Animation Smoothness
- Target 60 FPS on all animations
- Use Tween for smooth interpolation
- Avoid complex shaders on mobile
- Test on lower-end hardware

### UI/UX
- Resolution changes may require scene reload
- Provide visual feedback during resolution change
- Consider defaulting to native resolution detection
- Ensure font sizes scale appropriately

## Clarification Needed
- [ ] Should resolution change apply immediately or require restart?
- [ ] Should we auto-detect native resolution on first launch?
- [ ] Preferred 3D flip method: true 3D, shader-based, or scale simulation?
- [ ] Should high-DPI support adjust UI scale factor or just window size?

## Risks and Mitigation

### Risk 1: 3D Flip Performance on Mobile
- **Mitigation**: Implement scale-based simulation as fallback, profile on target devices, provide quality settings if needed

### Risk 2: Layout Issues at Different Aspect Ratios
- **Mitigation**: Extensive testing, use flexible containers, calculate tile sizes dynamically

### Risk 3: Font Scaling Problems
- **Mitigation**: Use dynamic font sizes based on viewport, test readability at all resolutions

### Risk 4: Resolution Change Disrupting Game State
- **Mitigation**: Save game state before change, reload cleanly, or require return to menu

## Estimated Effort
- Resolution management: 1-2 hours
- Dynamic tile sizing and centering: 2-3 hours
- 3D flip animation: 2-4 hours (depends on approach)
- Red blink feedback: 1 hour
- Testing across resolutions: 2 hours
- **Total: 8-12 hours**

---
**Status**: Implemented  
**Created**: 2024-12-24  
**Last Updated**: 2024-12-24  
**Approved By**: User
